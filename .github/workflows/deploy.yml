name: üöÄ Deploy to Sakura Server

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Erm√∂glicht manuelles Ausl√∂sen

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: üì¶ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: üîë Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        # SSH Host Key zum trusted hosts hinzuf√ºgen
        ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
        # Test SSH Verbindung
        echo "Testing SSH connection..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "echo 'SSH connection successful!'"
    
    - name: üìÅ Create Directory Structure (if needed)
      run: |
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
          ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
          "mkdir -p ${{ secrets.DEPLOY_PATH }} && chmod -R 755 ${{ secrets.DEPLOY_PATH }}"
    
    - name: üîÑ Sync Files with rsync
      run: |
        echo "Syncing files to server..."
        rsync -avz --delete \
          -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
          --exclude='.git/' \
          --exclude='.github/' \
          --exclude='.DS_Store' \
          --exclude='deploy.yml' \
          ./ \
          ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}/
    
    - name: ‚úÖ Verify Deployment
      run: |
        echo "Verifying deployed files..."
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
          ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
          "ls -la ${{ secrets.DEPLOY_PATH }}/ && echo 'Deployment completed successfully!'"
    
    - name: üìä Deployment Summary
      run: |
        echo "üöÄ Deployment Summary:"
        echo "‚úÖ Repository: ${{ github.repository }}"
        echo "‚úÖ Branch: ${{ github.ref }}"
        echo "‚úÖ Commit: ${{ github.sha }}"
        echo "‚úÖ Server: ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}"
        echo "‚úÖ Path: ${{ secrets.DEPLOY_PATH }}"
        echo "‚úÖ Website: https://sakura.hamidoudiallo.de"